define("bundles/assess/assessmentTypes/phoenixQuiz/assessment",["require","exports","module","bundles/quiz-common/utils/ProctorTimer","jquery","underscore","bundles/ondemand/stores/StoreComputationHelpers","bundles/page/lib/metatagsAddressBook","bundles/phoenix/lib/view","bundles/phoenix/template/models/userIdentity","pages/open-course/common/utils/ensureEnrolled","bundles/quiz/components/QuizCover","bundles/quiz/components/QuizModal"],function(require,exports,module){"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{"default":t}}var a=require("bundles/quiz-common/utils/ProctorTimer"),r=_interopRequireDefault(a),$=require("jquery"),_=require("underscore"),d=require("bundles/ondemand/stores/StoreComputationHelpers"),l=d.getDeadlineForItem,n=require("bundles/page/lib/metatagsAddressBook"),o=require("bundles/phoenix/lib/view"),i=require("bundles/phoenix/template/models/userIdentity"),s=require("pages/open-course/common/utils/ensureEnrolled"),m=require("bundles/quiz/components/QuizCover"),e=require("bundles/quiz/components/QuizModal"),t=function getMetadata(t){return function(){return this.model.get("metadata").get(t)}},u=o.extend({name:"itemView",bodyClasses:"c-item-assessment",multitracker:{namespace:"open_course.item_page.quiz",baseValues:["open_course_slug","module_id","module_name","lesson_id","lesson_name","item_id","item_name"],definitions:{open_course_slug:t("course.slug"),module_id:t("lesson.module.id"),module_name:t("lesson.module.name"),lesson_id:t("lesson.id"),lesson_name:t("lesson.name"),item_id:t("id"),item_name:t("name")},eventingVersion:2},firstReview:!0,initialize:function initialize(t){var e=this;$("body").addClass(this.bodyClasses),_.bindAll(this,"confirmedStart"),this.onStateChange=t.onStateChange,this.verificationDisplay=t.verificationDisplay,this.itemGrade=t.itemGrade,this.courseSlug=this.model.get("metadata.course.slug"),this.moduleNumber=this.model.get("metadata.lesson.module.index"),this.authenticated=i.get("authenticated"),this.isVerificationEnabled=this.model.get("metadata.course").isVerificationEnabled(),this.on("view:closing",this.onClose,this),n.setMetatags({pageName:"title-and-description",context:{title:this.model.get("metadata.name"),description:this.model.get("metadata.lesson.module.description")},options:{imageHref:this.model.get("metadata.course.promoPhoto")}}),t.params&&t.params.question_id&&this.firstReview&&(this.firstReview=!1,this.review()),this.proctorTimer=new r["default"]({proctorSummary:t.proctorSummary,onTick:function onTick(){e.renderQuizCover()},onDone:function onDone(){e.renderQuizCover()}})},calcDurationProps:function calcDurationProps(){var t=this.model.get("allowedSubmissionsPerInterval"),e=this.model.get("allowedSubmissionsInterval"),i=this.model.get("locksIfSubmittedBefore")-Date.now(),s=1===t?e:i;return{attemptsRateCount:t,attemptsRateInterval:e,lockedTimeLeft:s}},calcDeadline:function calcDeadline(){var e=this.model.get("metadata"),t=this.fluxibleContext.getComponentContext(),i=t.getStore("SessionStore");if(i.isEnrolled()){var s=t.getStore("CourseScheduleStore"),o=t.getStore("ProgressStore");return l(s,o,e)}return null},getPassingFraction:function getPassingFraction(){var e=this.fluxibleContext.getComponentContext(),t=e.getStore("CoursePresentGradeStore").getPresentGrade();return t&&t.isCumulativeGraded?void 0:this.model.getPassingFraction()},onClose:function onClose(){$("body").removeClass(this.bodyClasses)},closeModal:function closeModal(){this.hideLastAttemptModal(),this.hideTimedAttemptModal()},startQuiz:function startQuiz(){this.model.hasUnsubmittedAttempt()?this.confirmedStart():1===this.proctorTimer.getAttemptsLeft()?(this.closeModal(),this.showLastAttemptModal()):"exam"===this.model.get("metadata").getTypeName()&&this.model.isLastAttemptBeforeLock()?(this.closeModal(),this.showLastAttemptModal()):this.proctorTimer.getTimeLimit()?(this.closeModal(),this.showTimedAttemptModal()):this.confirmedStart()},start:function start(){var t=this.fluxibleContext.getComponentContext().getStore("ApplicationStore"),e=this.fluxibleContext.getComponentContext().getStore("CourseStore");if(!t.ensureAuthenticated())return null;var i=t.getUserData().id,o=e.getMetadata();s(i,o,this.verificationDisplay).then(this.startQuiz.bind(this)).fail(function(t){if(!(t instanceof s.UserRejectedEnrollPromptException))throw t}).done()},confirmedStart:function confirmedStart(){this.closeModal(),this.model.hasUnsubmittedAttempt()?this.track("resume"):this.track("start"),this.proctorTimer.stop(),this.onStateChange("attempt")},review:function review(){this.track("review"),this.proctorTimer&&this.proctorTimer.stop(),this.onStateChange("attempt",{attemptIndex:this.model.getLastSubmittedAttempt()})},render:function render(){return this.$el.html('\n      <div data-rc="QuizCover"></div>\n      <div data-rc="QuizModal"></div>\n    '),this.renderSubviews(),this.proctorTimer.getTimeLimit()&&this.model.hasUnsubmittedAttempt()&&this.proctorTimer.start(),this.authenticated&&this.model.hasSubmittedAttempt()&&this.model.examIsLocked&&this.model.examIsLocked()&&this.track("time_lock.render"),this},renderSubviews:function renderSubviews(){this.renderQuizCover()},renderQuizCover:function renderQuizCover(){var t=this.model.get("metadata"),e=this.model.getDisplayEvaluation(this.verificationDisplay),s=this.calcDurationProps();this.renderReactInto(m,"QuizCover",{itemMetadata:t,isAuthenticated:i.get("authenticated"),isItemLocked:t.isLockedForSessions(),type:t.getTypeName(),titlePrefix:t.getTitlePrefix(),title:t.get("name"),questionCount:this.model.getQuestionCount(),maxScore:e&&e.get("maxScore"),passFraction:this.getPassingFraction(),deadline:this.calcDeadline(),attemptsRateCount:s.attemptsRateCount,attemptsRateInterval:s.attemptsRateInterval,isInProgress:this.model.hasUnsubmittedAttempt(),isSubmitted:this.model.hasSubmittedAttempt(),isLocked:"exam"===t.getTypeName()&&this.model.examIsLocked(),lockedTimeLeft:s.lockedTimeLeft,isPassed:this.model.isPassed()||!1,relativePassingState:this.model.getRelativePassingState(this.verificationDisplay),score:e&&e.getDisplayScore(),attemptsLeft:this.proctorTimer.getAttemptsLeft(),timeLimit:this.proctorTimer.getTimeLimit(),timeLeft:this.proctorTimer.getTimeLeft(),timeWarn:this.proctorTimer.getTimeWarn(),onStart:this.start.bind(this),onReview:this.review.bind(this)})},showLastAttemptModal:function showLastAttemptModal(){this.renderReactInto(e,"QuizModal",{type:"lastAttempt",isOpen:!0,onRequestCancel:this.closeModal.bind(this),onRequestConfirm:this.confirmedStart.bind(this),timeLimit:this.proctorTimer.getTimeLimit(),lockedTimeLeft:this.calcDurationProps().lockedTimeLeft})},hideLastAttemptModal:function hideLastAttemptModal(){this.renderReactInto(e,"QuizModal",{isOpen:!1,onRequestCancel:this.closeModal.bind(this)})},showTimedAttemptModal:function showTimedAttemptModal(){this.renderReactInto(e,"QuizModal",{type:"timedAttempt",isOpen:!0,onRequestCancel:this.closeModal.bind(this),onRequestConfirm:this.confirmedStart.bind(this),timeLimit:this.proctorTimer.getTimeLimit(),hasAttemptLimit:this.calcDurationProps().attemptsRateCount>0||this.proctorTimer.getAttemptsLeft()>0})},hideTimedAttemptModal:function hideTimedAttemptModal(){this.renderReactInto(e,"QuizModal",{isOpen:!1,onRequestCancel:this.closeModal.bind(this)})}});module.exports=u});